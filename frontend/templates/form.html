{% extends "base.html" %}
{% block title %}Schedule a Meeting{% endblock %}
{% block content %}
<div class="container py-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>ðŸ“… Book a Zoom Meeting</h2>
        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
            <i class="fas fa-tachometer-alt me-2"></i>Back to Main Dashboard
        </a>
    </div>
</div>
<div class="container">
    <div class="card shadow-lg p-4">
        <form method="POST" action="/schedule" id="scheduleForm">
            <!-- Hidden input that will hold the final ISO timestamp -->
            <input type="hidden" name="start_time" id="start_time_iso" required>

            <div class="mb-3">
                <label class="form-label">Meeting Topic</label>
                <input type="text" class="form-control" name="topic" required autofocus>
            </div>

            <!-- IMPROVED DATE & TIME SELECTION -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="meeting_date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="meeting_date" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="meeting_time" class="form-label">Time (GST / UTC+4)</label>
                    <select class="form-select" id="meeting_time" required>
                        <!-- Time slots will be generated by JavaScript -->
                    </select>
                </div>
            </div>
            <!-- END OF IMPROVEMENT -->

            <div class="mb-3">
                <label class="form-label">Duration (minutes)</label>
                <input type="number" class="form-control" name="duration" value="30" min="1" max="240" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Agenda</label>
                <textarea class="form-control" name="agenda" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Host Email</label>
                <select class="form-control" name="host_email" required>
                    <option value="" disabled selected>-- Please select a host --</option>
                    <option value="meeting@6t3media.com">meeting@6t3media.com</option>
                    <option value="meeting_host@6t3media.com">meeting_host@6t3media.com</option>
                    <option value="meeting_host2@6t3media.com">meeting_host2@6t3media.com</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Participants (comma-separated emails)</label>
                <input type="text" class="form-control" name="participants" placeholder="e.g. user1@example.com, user2@example.com" required>
            </div>

            <button id="submitBtn" type="submit" class="btn btn-primary w-100">âœ… Schedule Meeting</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('meeting_date');
    const timeSelect = document.getElementById('meeting_time');
    const hiddenIsoInput = document.getElementById('start_time_iso');
    const form = document.getElementById('scheduleForm');

    // --- 1. Populate Time Slots ---
    function populateTimeSlots() {
        const now = new Date();
        // Round up to the next 15-minute interval
        const minutes = now.getMinutes();
        const roundedMinutes = Math.ceil(minutes / 15) * 15;
        now.setMinutes(roundedMinutes);
        now.setSeconds(0);
        now.setMilliseconds(0);

        for (let i = 0; i < 96; i++) { // 96 intervals of 15 minutes in 24 hours
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            const timeValue = `${hours}:${mins}`;
            
            const option = document.createElement('option');
            option.value = timeValue;
            option.textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            timeSelect.appendChild(option);

            now.setMinutes(now.getMinutes() + 15);
        }
    }

    // --- 2. Set Default Date ---
    function setDefaultDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
        dateInput.min = `${year}-${month}-${day}`; // Prevent selecting past dates
    }

    // --- 3. Update Hidden ISO Field ---
    function updateIsoTimestamp() {
        const dateValue = dateInput.value;
        const timeValue = timeSelect.value;

        if (dateValue && timeValue) {
            // Combine date and time, assuming GST (UTC+4)
            const localDateTimeString = `${dateValue}T${timeValue}:00.000+04:00`;
            const dateObj = new Date(localDateTimeString);

            // Convert to UTC and format as ISO string
            hiddenIsoInput.value = dateObj.toISOString();
            console.log("Updated ISO Timestamp (UTC):", hiddenIsoInput.value);
        }
    }

    // --- 4. Event Listeners ---
    dateInput.addEventListener('change', updateIsoTimestamp);
    timeSelect.addEventListener('change', updateIsoTimestamp);

    form.addEventListener("submit", function(event) {
        // Final update before submitting
        updateIsoTimestamp();

        if (!hiddenIsoInput.value) {
            alert("Please select a valid date and time.");
            event.preventDefault();
            return;
        }

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    });

    // --- Initial Setup ---
    populateTimeSlots();
    setDefaultDate();
    updateIsoTimestamp(); // Set initial value on page load
});
</script>
{% endblock %}
